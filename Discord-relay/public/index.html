<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>VF Discord Orchester - Device Management</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            display: flex;
            justify-content: center;
            align-items: center;
            padding: 20px;
        }

        .container {
            background: white;
            border-radius: 15px;
            padding: 40px;
            max-width: 900px;
            width: 100%;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
        }

        h1 {
            color: #5865F2;
            margin-bottom: 10px;
            font-size: 2em;
        }

        .subtitle {
            color: #666;
            margin-bottom: 30px;
        }

        .section {
            margin-bottom: 30px;
            padding: 20px;
            background: #f7f9fc;
            border-radius: 10px;
        }

        .section h2 {
            color: #333;
            margin-bottom: 15px;
            font-size: 1.3em;
        }

        .form-group {
            margin-bottom: 15px;
        }

        label {
            display: block;
            margin-bottom: 5px;
            color: #555;
            font-weight: 500;
        }

        input[type="text"], input[type="number"], select {
            width: 100%;
            padding: 10px;
            border: 2px solid #e0e0e0;
            border-radius: 5px;
            font-size: 14px;
            transition: border-color 0.3s;
        }

        input[type="text"]:focus, input[type="number"]:focus, select:focus {
            outline: none;
            border-color: #5865F2;
        }

        button {
            background: #5865F2;
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 5px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 600;
            transition: background 0.3s;
        }

        button:hover {
            background: #4752C4;
        }

        button.secondary {
            background: #ed4245;
        }

        button.secondary:hover {
            background: #c73739;
        }

        .device-list {
            display: grid;
            gap: 15px;
        }

        .device-card {
            background: white;
            padding: 15px;
            border-radius: 8px;
            border: 2px solid #e0e0e0;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .device-info {
            flex-grow: 1;
        }

        .device-id {
            font-weight: bold;
            color: #5865F2;
            font-size: 1.1em;
        }

        .device-owner {
            color: #666;
            font-size: 0.9em;
            margin-top: 5px;
        }

        .switch-mappings {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 10px;
            margin-top: 10px;
        }

        .switch-mapping {
            background: #f0f0f0;
            padding: 8px;
            border-radius: 5px;
            font-size: 0.85em;
        }

        .switch-label {
            font-weight: bold;
            color: #333;
        }

        .user-name {
            color: #5865F2;
        }

        .message {
            padding: 12px;
            border-radius: 5px;
            margin-bottom: 20px;
            display: none;
        }

        .message.success {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }

        .message.error {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }

        .message.show {
            display: block;
        }

        .loading {
            text-align: center;
            padding: 20px;
            color: #666;
        }

        .btn-group {
            display: flex;
            gap: 10px;
        }

        .inline-form {
            display: flex;
            gap: 10px;
            align-items: end;
        }

        .inline-form .form-group {
            flex: 1;
            margin-bottom: 0;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>üéÆ VF Discord Orchester</h1>
        <p class="subtitle">Multi-User Device Management</p>

        <div id="message" class="message"></div>

        <!-- Device Registration Section -->
        <div class="section">
            <h2>üì± Register Your Device</h2>
            <form id="registerForm" class="inline-form">
                <div class="form-group">
                    <label for="deviceId">Device ID (from your ESP32)</label>
                    <input type="text" id="deviceId" name="deviceId" placeholder="e.g., ESP32-A1B2C3D4" required>
                </div>
                <div class="form-group">
                    <label for="ownerName">Your Name</label>
                    <input type="text" id="ownerName" name="ownerName" placeholder="e.g., John Doe" required>
                </div>
                <div class="form-group">
                    <label>&nbsp;</label>
                    <button type="submit">Register Device</button>
                </div>
            </form>
        </div>

        <!-- Configure Mappings Section -->
        <div class="section">
            <h2>‚öôÔ∏è Configure Switch Mappings</h2>
            <p style="color: #666; margin-bottom: 15px;">Select your device and configure which Discord users each switch controls.</p>
            <form id="mappingForm">
                <div class="form-group">
                    <label for="selectDevice">Select Your Device</label>
                    <select id="selectDevice" name="selectDevice" required>
                        <option value="">-- Select a device --</option>
                    </select>
                </div>
                
                <div id="switchConfig" style="display: none;">
                    <h3 style="margin: 20px 0 10px; color: #333;">Switch Configuration</h3>
                    <div class="switch-mappings">
                        <div>
                            <div class="form-group">
                                <label for="switch0User">Switch 0 - User ID</label>
                                <input type="text" id="switch0User" placeholder="Discord User ID">
                            </div>
                            <div class="form-group">
                                <label for="switch0Target">Switch 0 - Target ID</label>
                                <input type="text" id="switch0Target" placeholder="Discord User ID">
                            </div>
                        </div>
                        <div>
                            <div class="form-group">
                                <label for="switch1User">Switch 1 - User ID</label>
                                <input type="text" id="switch1User" placeholder="Discord User ID">
                            </div>
                            <div class="form-group">
                                <label for="switch1Target">Switch 1 - Target ID</label>
                                <input type="text" id="switch1Target" placeholder="Discord User ID">
                            </div>
                        </div>
                        <div>
                            <div class="form-group">
                                <label for="switch2User">Switch 2 - User ID</label>
                                <input type="text" id="switch2User" placeholder="Discord User ID">
                            </div>
                            <div class="form-group">
                                <label for="switch2Target">Switch 2 - Target ID</label>
                                <input type="text" id="switch2Target" placeholder="Discord User ID">
                            </div>
                        </div>
                    </div>
                    <button type="submit" style="margin-top: 15px;">Save Mappings</button>
                </div>
            </form>
        </div>

        <!-- Registered Devices Section -->
        <div class="section">
            <h2>üìã Registered Devices</h2>
            <div id="deviceList" class="loading">Loading devices...</div>
        </div>
    </div>

    <script>
        const API_BASE = '/vf/api';

        // Show message
        function showMessage(text, type) {
            const msg = document.getElementById('message');
            msg.textContent = text;
            msg.className = `message ${type} show`;
            setTimeout(() => {
                msg.classList.remove('show');
            }, 5000);
        }

        // Load all devices
        async function loadDevices() {
            try {
                const response = await fetch(`${API_BASE}/devices`);
                const data = await response.json();
                
                const deviceList = document.getElementById('deviceList');
                const selectDevice = document.getElementById('selectDevice');
                
                // Update device selector
                selectDevice.innerHTML = '<option value="">-- Select a device --</option>';
                
                if (data.devices && data.devices.length > 0) {
                    // Populate device list
                    deviceList.innerHTML = data.devices.map(device => {
                        const switches = device.mappings ? device.mappings.switches : [];
                        return `
                            <div class="device-card">
                                <div class="device-info">
                                    <div class="device-id">${device.deviceId}</div>
                                    <div class="device-owner">Owner: ${device.ownerName}</div>
                                    ${switches.length > 0 ? `
                                        <div class="switch-mappings">
                                            ${switches.map((sw, idx) => `
                                                <div class="switch-mapping">
                                                    <div class="switch-label">Switch ${idx}</div>
                                                    <div>User: <span class="user-name">${sw.userId || 'Not set'}</span></div>
                                                    <div>Target: <span class="user-name">${sw.targetUserId || 'Not set'}</span></div>
                                                </div>
                                            `).join('')}
                                        </div>
                                    ` : '<div style="color: #999; margin-top: 5px;">No mappings configured</div>'}
                                </div>
                                <div class="btn-group">
                                    <button onclick="deleteDevice('${device.deviceId}')" class="secondary">Delete</button>
                                </div>
                            </div>
                        `;
                    }).join('');
                    
                    // Populate selector
                    data.devices.forEach(device => {
                        const option = document.createElement('option');
                        option.value = device.deviceId;
                        option.textContent = `${device.deviceId} (${device.ownerName})`;
                        selectDevice.appendChild(option);
                    });
                } else {
                    deviceList.innerHTML = '<p style="color: #999;">No devices registered yet.</p>';
                }
            } catch (error) {
                console.error('Error loading devices:', error);
                document.getElementById('deviceList').innerHTML = '<p style="color: #ed4245;">Error loading devices</p>';
            }
        }

        // Register device
        document.getElementById('registerForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            const formData = new FormData(e.target);
            const data = {
                deviceId: formData.get('deviceId'),
                ownerName: formData.get('ownerName')
            };

            try {
                const response = await fetch(`${API_BASE}/devices`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(data)
                });

                const result = await response.json();
                
                if (response.ok) {
                    showMessage('Device registered successfully!', 'success');
                    e.target.reset();
                    loadDevices();
                } else {
                    showMessage(result.error || 'Failed to register device', 'error');
                }
            } catch (error) {
                showMessage('Error registering device', 'error');
                console.error(error);
            }
        });

        // Show switch config when device is selected
        document.getElementById('selectDevice').addEventListener('change', async (e) => {
            const deviceId = e.target.value;
            const switchConfig = document.getElementById('switchConfig');
            
            if (!deviceId) {
                switchConfig.style.display = 'none';
                return;
            }
            
            switchConfig.style.display = 'block';
            
            // Load existing mappings
            try {
                const response = await fetch(`${API_BASE}/devices/${encodeURIComponent(deviceId)}/mappings`);
                const data = await response.json();
                
                if (data.switches) {
                    data.switches.forEach((sw, idx) => {
                        document.getElementById(`switch${idx}User`).value = sw.userId || '';
                        document.getElementById(`switch${idx}Target`).value = sw.targetUserId || '';
                    });
                }
            } catch (error) {
                console.error('Error loading mappings:', error);
            }
        });

        // Save mappings
        document.getElementById('mappingForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            const deviceId = document.getElementById('selectDevice').value;
            
            if (!deviceId) {
                showMessage('Please select a device', 'error');
                return;
            }

            const switches = [];
            for (let i = 0; i < 3; i++) {
                const userId = document.getElementById(`switch${i}User`).value;
                const targetUserId = document.getElementById(`switch${i}Target`).value;
                
                if (userId || targetUserId) {
                    switches.push({
                        switchId: i,
                        userId: userId || '',
                        targetUserId: targetUserId || ''
                    });
                }
            }

            try {
                const response = await fetch(`${API_BASE}/devices/${encodeURIComponent(deviceId)}/mappings`, {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ switches })
                });

                const result = await response.json();
                
                if (response.ok) {
                    showMessage('Mappings saved successfully!', 'success');
                    loadDevices();
                } else {
                    showMessage(result.error || 'Failed to save mappings', 'error');
                }
            } catch (error) {
                showMessage('Error saving mappings', 'error');
                console.error(error);
            }
        });

        // Delete device
        async function deleteDevice(deviceId) {
            if (!confirm(`Are you sure you want to delete device ${deviceId}?`)) {
                return;
            }

            try {
                const response = await fetch(`${API_BASE}/devices/${encodeURIComponent(deviceId)}`, {
                    method: 'DELETE'
                });

                if (response.ok) {
                    showMessage('Device deleted successfully!', 'success');
                    loadDevices();
                } else {
                    const result = await response.json();
                    showMessage(result.error || 'Failed to delete device', 'error');
                }
            } catch (error) {
                showMessage('Error deleting device', 'error');
                console.error(error);
            }
        }

        // Load devices on page load
        loadDevices();
    </script>
</body>
</html>
